import java.io.*;
import java.util.*;


public class main {
	public static class Container{
		public String name = "";
		public int val = 0;
		public  String reg = "";
		public  boolean number = false;
		public Container(String name_, int val_, String reg_,boolean number_){
			name = name_;
			val = val_;
			reg = reg_;
			number = number_;
		}
		public Container(){}
	}
	public static ArrayList<Container> variables = new ArrayList<Container>();
	public static int counter = 0;
	
	public static int pri(String c){
		if (c.equals("*") || c.equals("/"))
			return 1;
		else if (c.equals("+") || c.equals("-"))
			return 2;	
		else
			return 3;
	}
	public static ArrayList<String> infToPos(String[] str){
		ArrayList<String> res = new ArrayList<>();
		Stack<String> stk = new Stack<>();
		for (int i = 0; i < str.length; i++) {
			if (str[i].equals("+") || str[i].equals("-") || str[i].equals("*") || str[i].equals("/")) {
				while(!stk.isEmpty() && pri(stk.peek()) <= pri(str[i])){
					res.add(stk.pop());
				}
				stk.push(str[i]);
			}
			else if(str[i].equals("(")){
				stk.push(str[i]);
			}
			else if(str[i].equals(")")){
				while(!stk.peek().equals("(")){
					res.add(stk.pop());
				}
				stk.pop();
			}
			else{
				res.add(str[i]);
			}
		}
		while(!stk.isEmpty()){
			res.add(stk.pop());
		}
		return res;
	}

	public static Container findC(String s){
		if(!isNumber(s)){
			for (int i = 0; i < variables.size(); i++) {
				if(variables.get(i).name.equals(s)){
					return variables.get(i);
				}
			}
			//if(!ContainsVar(s)){
				//Container x = new Container(s, 0,  s, false);
				//return x;
			//}
		}
		Container x = new Container("number", Integer.parseInt(s),  s, true);
		return x;
	}
	
	public static boolean isSign(String s){
		if(s.equals("+") || s.equals("-") || s.equals("/") || s.equals("*")){
			return true;
		}
		else{
			return false;
		}		
	}

	public static boolean isNumber(String s){
		for (int i = 0; i < s.length(); i++) {
			if(s.matches("^-?\\d+$")){
				return true;
			}
		}
		return false;
	}
	
	public static Container evaluate(ArrayList<String> exp){
		if(exp.size() == 1){
			Container x = findC(exp.get(0));
			counter++;
			System.out.println("%" + counter + " = load i32* %" + x.name);
		}
		ArrayList<String> names = new ArrayList<String>();
		Stack<Container> stk = new Stack<>();
		for (int i = 0; i < exp.size(); i++) {
			if(!isSign(exp.get(i))){
				stk.push(findC(exp.get(i)));
			}
			else{
				String oper = exp.get(i);
				Container first = stk.pop();
				if(!first.number && !names.contains(first.name)){
					counter++;
					System.out.println("%" + counter + " = load i32* %" + first.name);
					first.reg = "" + counter;
					names.add(first.name);
				}
				Container second = stk.pop();
				if(!second.number && !names.contains(second.name)){
					counter++;
					System.out.println("%" + counter + " = load i32* %" + second.name);
					second.reg = "" + counter;
					names.add(second.name);
				}
				counter++;	
				if(oper.equals("+")){
					String name = "" + counter;
					Container result = new Container("register", first.val + second.val, name, true);
					stk.push(result);
					String message = "%" + result.reg + " = add i32 ";
					message = first.number  && !first.name.equals("register")? message + first.reg : message + "%" + first.reg;
					message = message + ",";
					message = second.number  && !second.name.equals("register") ? message + second.reg : message + "%" + second.reg;
					System.out.println(message);
				 }
				else if(oper.equals("*")){
					String name = "" + counter;
					Container result = new Container("register", first.val * second.val, name, true);
					stk.push(result);
					String message = "%" + result.reg + " = mul i32 ";
					message = first.number && !first.name.equals("register")? message + first.reg : message + "%" + first.reg;
					message = message + ",";
					message = second.number  && !second.name.equals("register") ? message + second.reg : message + "%" + second.reg;
					System.out.println(message);
				 }
				else if(oper.equals("/")){
					String name = "" + counter;
					Container result = new Container("register", second.val / first.val , name, true);
					stk.push(result);
					String message = "%" + result.reg + " = sdiv i32 ";
					message = first.number  && !first.name.equals("register")? message + first.reg : message + "%" + first.reg;
					message = message + ",";
					message = second.number  && !second.name.equals("register") ? message + second.reg : message + "%" + second.reg;
					System.out.println(message);
				 }
				else if(oper.equals("-")){
					String name = "" + counter;
					Container result = new Container("register", second.val - first.val, name, true);
					stk.push(result);
					String message = "%" + result.reg + " = sub i32 ";
					message = first.number && !first.name.equals("register") ? message + first.reg : message + "%" + first.reg;
					message = message + ",";
					message = second.number  && !second.name.equals("register")? message + second.reg : message + "%" + second.reg;
					System.out.println(message);
				 }
			}
		}
		return stk.pop();
	}
	
	public static boolean ContainsVar(String x){
		for (int i = 0; i < variables.size(); i++) {
			if(variables.get(i).name.equals(x)){
				return true;
			}
		}
		return false;
	}
	
	public static void main(String[] args) throws FileNotFoundException {
		int linee = 0;
		boolean errors = false;
		//System.setOut(new PrintStream(new BufferedOutputStream(new FileOutputStream("file.ll"))));
		System.out.println(";ModuleID = \'stm2ir\'\ndeclare i32 @printf(i8*, ...)\n@print.str = constant [4 x i8] c\"%d\\0A\\00\"\n\ndefine i32 @main() {");
		Scanner input = new Scanner(new File("file.stm"));
		while(input.hasNextLine()){
			linee++;
			try {
			String str = input.nextLine();
			//if '=' exist
			int x = str.indexOf('=');
			//Whether query contains = sign or not. Nice...
			String str_;String var = "";
			Container contt = new Container("", 0, "", false);
			boolean assign = false;
			if(x != -1){
				str_ = str.split("=")[1];
				var = str.split("=")[0];
				assign = true;
				if(!ContainsVar(var)){
					contt = new Container(var, 0, var, false);
					variables.add(contt);
					System.out.println("%" + var + " = alloca i32");
				}				
			}
			else{str_ = str;}
			String[] parts = str_.split("(?<=[^\\.a-zA-Z\\d])|(?=[^\\.a-zA-Z\\d])");
			if(parts.length == 1 && assign){
				System.out.println("store i32 "+ parts[0] + ", i32* %" + var);
				contt.val = Integer.parseInt(parts[0]);
				continue;
			}
			else if (!assign){
				ArrayList<String> s = infToPos(parts);
				while(s.contains(" ")){s.remove(" ");}//This is for white spaces.
				Container regg =evaluate(s);
				System.out.println("call i32 (i8*, ...)* @printf(i8* getelementptr ([4 x i8]* @print.str, i32 0, i32 0), i32 %" + counter);
				counter++;
				continue;
			}
			ArrayList<String> s = infToPos(parts);
			while(s.contains(" ")){s.remove(" ");}
			Container regg =evaluate(s);
			System.out.println("store i32 %"+ counter + ", i32* %" + var);
			} 
			catch (Exception e) {
				System.out.println(e);
				//System.out.println("Error: Line "+linee+": Syntax error");
				errors = true;
				break;
			}
		}
		if(!errors){
			System.out.println("ret i32 0\n}");
		}
	}
}
